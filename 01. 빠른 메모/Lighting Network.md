라이트닝 네트워크는 비트코인 메인 체인의 느린 거래 속도와 높은 수수료를 해결하기 위해 탄생하였다. 라이트닝 네트워크를 통해 smart contract가 가능하다.
1. P2P로 양방향 결제 채널을 생성한다. 
2. 결제 채널을 생성한 내용의 트랜잭션을 비트코인 메인 체인에 기록한다.
3. 첫번째 트랜잭션 이후로 여러 트랜잭션들을 쌓는다.
4. 거래가 끝난다면 가장 마지막 트랜잭션만을 비트코인 메인 체인에 기록한다.
![[Pasted image 20241206200832.png]]
- 이렇게 첫번째 커밋 이후에 일어나는 off-chain 커밋들은 블록체인에 기록되지 않는다.
- 처음에 넣은 양(140000) 보다 더 많게 송금할 수는 없으므로, 이를 channel capacity라고 한다.
- 하지만 계속 왔다갔다 하면서 flow 자체는 140000보다 많이질 수 있다.


![[Pasted image 20241206201123.png]]
각 트랜잭션은 이렇게 생겼다.
- 양쪽의 트랜잭션은 commitmet의 순서는 같지만, output의 순서가 다르다.
- 처음 output은 일정 금액을 3일 후에 자신에게 보내거나, 또는 remote key를 제시한 경우 곧바로 remote에 보낼 수 있다.
- 이를 통해 상대방은 cheating을 감지한 즉시 모든 돈을 자신에게 향하게 만들 수 있다. -> 응징을 통해 사기를 막는다.
### Commitmet의 장점
- 상대방이 비협조적이라면, 마지막 commitment를 뿌리고 채널을 닫아버릴 수 있다.
- 다른 참여자가 자신에게 유리한 commitment만 뿌린다면, revoke key를 통해 모든 돈을 다 챙길 수 있다. (응징)
### Lighting Network에 트랜잭션을 만드는 방법
- 각 트랜잭션은 상대방의 서명이 필요하다. 따라서 현재 트랜잭션에 대해 서명을 제공해야 한다.
- 이전 트랜잭션을 사용할 수 없도록 revoke key를 제공한다.
	- 만약 해당 트랜잭션이 블록체인에 포함되면, 일정 블록 개수가 append 되기 전에 revoke key를 통해 그대로 전부 가져올 수 있다. (응징)
	- 이는 timelock 덕분에 가능하다. timelock 안에 이상 트랜잭션이 블록체인에 포함된 것을 감지할 수만 있다면 응징할 수 있는 것이다.
![[Pasted image 20241206214152.png]]
## Payments Channels
- Channel로 연결되지 않은 상대방과도 거래할 수 있다.
- 다른 노드들을 통하여 연결된다.
	- 이때 각 노드들은 일정 수수료를 받는다.
- 한 노드가 '내 노드를 중간 노드로 사용해도 좋아'라고 말하는 것을 `Announcing Channel`이라고 한다.
	- 이 프로토콜을 `가십 프로토콜`이라고 부른다.
![[Pasted image 20241207190515.png]]
## Invocies
- Lighting Network에서의 암호화폐 지불을 위한 방법이다.
- 수취인 공개키, 지불 금액 등을 포함한 값을 Base58 등으로 인코딩하여 만든다.
- invocies는 오프라인을 통해 전달되며, 받은 사람은 이 코드를 통해 암호화폐를 지불할 수 있다.
### 생성
- Bob은 무작위 수 r을 정한다.
- SHA256 해시한다. H = SHA256(r)
- 추가적인 메타데이터를 넣는다.
	- 짧은 설명
	- rounting hints : invocies의 라우팅을 만들기 위해 사용
	- expiry date : 지불 후에 invocies의 r이 다시 free 해질 수 있도록 사용
- 이를 전파한다.
### Goship Protocol
#### P2P 가십 프로토콜을 통해 채널 정보를 통신한다.
1. 채널을 오픈한 노드는 channel_announcement 메시지를 피어들에게 전송한다.
2. 각 피어는 수신한 채널 정보를 검증한다.
3. 검증 후에 자신의 피어에게 메시지를 그대로 전달한다.
4. 이렇게 네트워크 상에서 채널 정보가 확산된다.
#### 가십 프로토콜을 통해 메타데이터를 송수신할 수 있다.
- 이 메타데이터를 통해 채널의 현재 상태를 제공함으로써, 네트워크 내부에서 라우팅 결정을 돕는다. (최적화)
- channel_update 메시지를 통해 공유된다.
- 과도한 통신을 방지하기 위해 채널당 하루에 약 4회만 메시지 전파된다.
#### 도전과제
- 가십 네트워크에서는 채널의 총 용량은 전파하지만, 상세한 잔액 분포는 전파하지 않는다.
	- 실제로 전송 가능한 암호화폐는 로컬 잔액 분포만큼만 가능하다.
- 하지만 여기에는 이유가 있다.
	- 프라이버시 보호
	- 확장성 : Lighting Network의 지불 규모를 확장하기 위함
	- 네트워크 동적성 : 실시간으로 바뀌는 네트워크의 상황을 계속 업데이트 하는 것은 효율도 낮고 의미가 X
#### PathFinding
- 지불 출발점에서 목적지까지의 경로를 찾는 과정이다.
- 해당 경로를 통해 실제 지불이 이루어지는 과정은 `Routing`이라고 부른다.
- PathFinding은 `발신자 기반 경로 찾기` 방법으로 한다.
	- 지불 발신자가 직접 네트워크를 통해 목적지까지의 경로를 찾는다.
	- 발신자가 전체 경로를 계산하고 결정한다.
- Routing은 `양파 라우팅` 방법으로 한다.
	- 경로의 각 요소들이 양파의 층처럼 겹겹이 암호화된다.
	- 각 노드는 자신의 계층만 해독할 수 있다.
	- 이를 통해 높은 수준의 프라이버시와 보안을 제공한다.
### 공정성
Lighting Network의 공정성을 지키는 3가지 키워드가 있다.
- 무신뢰성
	- 참여자들은 제 3자를 신뢰할 필요가 없다.
	- 단지 프로토콜을 신뢰하기만 하면 된다. 프로토콜이 부정행위를 막는다.
- 원자성
	- 모든 지불은 온전히 실행되거나 온전히 실패된다.
	- 이 덕분에 중개자들이 Payment를 받고 다음 단계로 전달하지 않는 상황을 막는다.
- 다중 홉 보안
	- 단일 채널 뿐만 아니라, 여러 채널을 통과하는 Payment에 대해서도 똑같은 공정성을 제공한다.
![[Pasted image 20241207193647.png]]