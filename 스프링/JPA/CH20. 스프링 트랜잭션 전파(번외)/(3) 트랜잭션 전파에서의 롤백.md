# 트랜잭션 전파에서의 롤백

- 여러 트랜잭션이 전파되어 있는 상황을 가정해보자.
- 여러 논리 트랜잭션 중 하나에서 문제가 발생해서 예외를 던지는 경우가 발생할 수 있다.
- 그러면 해당 논리 트랜잭션이 롤백될 것이고, 전체 물리 트랜잭션도 롤백된다.

## 어떻게 롤백되는가?

- 외부 트랜잭션(트랜잭션을 시작한 곳)에서 롤백되면 그냥 트랜잭션 매니저를 통해 롤백한다.
- 내부 트랜잭션에서 롤백되면 직접 롤백할 수 없다. 트랜잭션 매니저의 `rollbackOnly`옵션을 true로 설정한다.
  - 후에 외부 트랜잭션의 커밋 시점에 `rollbackOnly`를 확인하여 true라면 롤백하게 된다.

## 문제 상황

- 만약 예외가 발생한 논리 트랜잭션이 중요치 않은 트랜잭션이라, 외부에서 예외를 잡았다고 가정하자.
- 그러면 예외가 잡혔으니 롤백이 되지않았을 것이라고 생각할 수 있지만 아니다.
- 이미 예외를 던지는 시점에서 `rollbackOnly=true`이며, 예외 흐름이 아니어도 롤백된다.

### 중요치 않은 트랜잭션

- 그러면 중요치 않은 트랜잭션이 실패하더라도 그것을 제외한 트랜잭션을 커밋하는 방법은 무엇이 있을까?
- 바로 해당 트랜잭션을 `REQUIRES_NEW`로 분리시키는 것이다.
- 이렇게 하면 해당 트랜잭션이 독립적인 물리 트랜잭션을 갖기 때문에 위 문제가 발생하지 않는다.
